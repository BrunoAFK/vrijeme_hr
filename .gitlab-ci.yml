stages:
  - validate
  - release

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  MANIFEST_PATH: "custom_components/vrijeme_hr/manifest.json"

cache:
  key: "$CI_PROJECT_ID-pip"
  paths:
    - .cache/pip

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

validate_manifest_and_translations:
  stage: validate
  image: python:3.12-alpine
  script:
    - python -V
    - python - <<'PY'
import json
import pathlib
import sys

manifest_path = pathlib.Path("custom_components/vrijeme_hr/manifest.json")
if not manifest_path.exists():
    raise SystemExit(f"Missing manifest: {manifest_path}")

manifest = json.loads(manifest_path.read_text(encoding="utf-8"))
keys = list(manifest.keys())
if len(keys) < 2 or keys[0] != "domain" or keys[1] != "name":
    raise SystemExit("Manifest keys must start with: domain, name")

expected_rest = sorted(keys[2:])
if keys[2:] != expected_rest:
    raise SystemExit(f"Manifest keys after domain/name must be alphabetical: {keys[2:]}")

required = [
    "domain",
    "name",
    "integration_type",
    "iot_class",
    "version",
    "documentation",
    "issue_tracker",
]
missing = [k for k in required if not manifest.get(k)]
if missing:
    raise SystemExit(f"Manifest missing required keys: {missing}")

translations_dir = manifest_path.parent / "translations"
if translations_dir.exists():
    for tr_path in sorted(translations_dir.glob("*.json")):
        data = json.loads(tr_path.read_text(encoding="utf-8"))
        config = data.get("config", {})
        steps = config.get("step", {})
        for step_name, step_value in steps.items():
            data_map = step_value.get("data", {})
            for field, value in data_map.items():
                if not isinstance(value, str):
                    raise SystemExit(
                        f"{tr_path}: config.step.{step_name}.data.{field} must be a string"
                    )

print("Manifest + translations validation passed")
PY
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_PIPELINE_SOURCE == "web"'

validate_python_syntax:
  stage: validate
  image: python:3.12-alpine
  script:
    - python -m compileall -q custom_components
    - echo "Python syntax validation passed"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_PIPELINE_SOURCE == "web"'

release_on_manifest_version_change:
  stage: release
  image: alpine:3.20
  before_script:
    - apk add --no-cache bash git curl jq
  script:
    - |
      set -euo pipefail

      if [[ ! -f "$MANIFEST_PATH" ]]; then
        echo "Manifest not found: $MANIFEST_PATH"
        exit 1
      fi

      NEW_VERSION="$(jq -r '.version // empty' "$MANIFEST_PATH")"
      if [[ -z "$NEW_VERSION" ]]; then
        echo "Could not read version from $MANIFEST_PATH"
        exit 1
      fi

      if [[ ! "$NEW_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z]+)*$ ]]; then
        echo "Version '$NEW_VERSION' is not valid semver-like format"
        exit 1
      fi

      OLD_VERSION=""
      if [[ -n "${CI_COMMIT_BEFORE_SHA:-}" ]] && [[ "$CI_COMMIT_BEFORE_SHA" != "0000000000000000000000000000000000000000" ]]; then
        OLD_VERSION="$(git show "$CI_COMMIT_BEFORE_SHA:$MANIFEST_PATH" 2>/dev/null | jq -r '.version // empty' || true)"
      fi

      if [[ "$OLD_VERSION" == "$NEW_VERSION" ]]; then
        echo "Manifest changed but version stayed the same ($NEW_VERSION)."
        exit 0
      fi

      TAG="v$NEW_VERSION"
      if git ls-remote --tags origin "refs/tags/$TAG" | grep -q "refs/tags/$TAG$"; then
        echo "Tag $TAG already exists."
        exit 0
      fi

      if [[ -z "${GITLAB_TOKEN:-}" ]]; then
        echo "Missing GITLAB_TOKEN variable. Create a Project Access Token with api scope and set it as masked CI variable."
        exit 1
      fi

      TAG_API="$CI_API_V4_URL/projects/$CI_PROJECT_ID/repository/tags"
      RELEASE_API="$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"

      curl --fail --silent --show-error --request POST \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        --data-urlencode "tag_name=$TAG" \
        --data-urlencode "ref=$CI_COMMIT_SHA" \
        --data-urlencode "message=Release $TAG" \
        "$TAG_API"

      curl --fail --silent --show-error --request POST \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        --data-urlencode "name=$TAG" \
        --data-urlencode "tag_name=$TAG" \
        --data-urlencode "description=Automated release generated from manifest version change." \
        "$RELEASE_API"

      echo "Release $TAG created."
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - custom_components/vrijeme_hr/manifest.json
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
